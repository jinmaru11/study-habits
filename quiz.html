<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>問題に挑戦｜Study Habits</title>

<style>
body{
  margin:0;
  background:#f4f4f4;
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
}
header{
  background:#b00020;
  color:white;
  padding:16px;
  text-align:center;
  font-weight:bold;
}
main{
  max-width:600px;
  margin:auto;
  padding:16px;
}
.card{
  background:white;
  padding:16px;
  border-radius:12px;
}
.choice{
  width:100%;
  padding:14px;
  margin-top:10px;
  border:none;
  border-radius:10px;
  font-size:16px;
  background:#eee;
}
.correct{ background:#b00020; color:white; }
.wrong{ background:#ccc; color:#333; }

button.next{
  margin-top:16px;
  width:100%;
  padding:16px;
  border:none;
  border-radius:12px;
  font-size:18px;
  background:#b00020;
  color:white;
}

/* ===== 偉人カード演出 ===== */
.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.6);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:999;
}
.hero{
  padding:24px;
  border-radius:16px;
  text-align:center;
  animation:flip 1s;
  background:white;
}
.hero.common{ background:#e0e0e0; }
.hero.rare{ background:#8ecae6; }
.hero.legendary{
  background:linear-gradient(135deg,#ffd700,#fff5b7,#ffd700);
  box-shadow:0 0 20px rgba(255,215,0,0.8);
}
.hero h2{ margin:0; }
.hero p{ margin:8px 0 0; font-size:14px; }

@keyframes flip{
  from{ transform:rotateY(90deg); opacity:0 }
  to{ transform:rotateY(0); opacity:1 }
}

/* ===== Legendary 専用抽選演出 ===== */
.card-back{
  width:260px;
  height:360px;
  border-radius:18px;
  background:linear-gradient(135deg,#ffd700,#fff1a8,#ffd700);
  box-shadow:0 0 30px rgba(255,215,0,.9);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:28px;
  font-weight:bold;
  animation:spin 1.2s ease-in-out;
}

@keyframes spin{
  0%{ transform:rotateY(0deg); }
  50%{ transform:rotateY(180deg); }
  100%{ transform:rotateY(360deg); }
}
</style>
</head>

<body>

<header>
  問題に挑戦
  <div id="progress" style="font-size:14px;margin-top:4px;"></div>
</header>

<main>
  <div class="card">
    <div id="q" style="font-size:18px;font-weight:bold;"></div>
    <div id="choices"></div>
  </div>

  <button class="next" onclick="next()">次へ</button>
</main>

<script>
/* =====================================================
   成長スコア
===================================================== */
function getGrowthScore(){
  return Number(localStorage.getItem("growthScore") || 0);
}
function addGrowthScore(){
  const next = Math.round((getGrowthScore() + 0.1) * 10) / 10;
  localStorage.setItem("growthScore", next);
  return next;
}

/* =====================================================
   偉人データ
===================================================== */
const HEROES = {
  common: [
    { id:"c1", name:"エジソン", job:"発明家", quote:"天才とは1%のひらめきと99%の努力である" },
    { id:"c2", name:"ダーウィン", job:"生物学者", quote:"生き残るのは最も強い者ではない" },
    { id:"c3", name:"ナポレオン", job:"軍人", quote:"勝利は最も忍耐強い者にもたらされる" }
  ],
  rare: [
    { id:"r1", name:"アインシュタイン", job:"物理学者", quote:"想像力は知識より重要だ" },
    { id:"r2", name:"ガリレオ", job:"天文学者", quote:"それでも地球は動いている" }
  ],
  legendary: [
    { id:"l1", name:"レオナルド・ダ・ヴィンチ", job:"万能の天才", quote:"学ぶことをやめた者は老いる" }
  ]
};

/* =====================================================
   抽選ロジック
===================================================== */
function drawHeroType(score){
  const table = [{ type:"common", rate:75 }];
  if(score >= 2) table.push({ type:"rare", rate:22 });
  if(score >= 5) table.push({ type:"legendary", rate:3 });

  let r = Math.random() * table.reduce((s,x)=>s+x.rate,0);
  for(const t of table){
    if(r < t.rate) return t.type;
    r -= t.rate;
  }
}
function getHeroByType(type){
  const list = HEROES[type];
  return list[Math.floor(Math.random() * list.length)];
}

/* =====================================================
   ownedHeroes 保存（IDのみ）
===================================================== */
function saveHero(hero){
  const owned = JSON.parse(localStorage.getItem("ownedHeroes") || "[]");
  if(!owned.includes(hero.id)){
    owned.push(hero.id);
    localStorage.setItem("ownedHeroes", JSON.stringify(owned));
  }
}

/* =====================================================
   問題表示
===================================================== */
const raw = localStorage.getItem("questions");
const questions = raw ? JSON.parse(raw) : [];
let i = 0;
let answered = false;

function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}
function show(){
  answered = false;
  const q = questions[i];
  document.getElementById("q").textContent = q.question;
  document.getElementById("progress").textContent = `${i+1} / ${questions.length}`;

  const area = document.getElementById("choices");
  area.innerHTML = "";
  shuffle(q.choices);
  q.choices.forEach(text=>{
    const b = document.createElement("button");
    b.className = "choice";
    b.textContent = text;
    b.onclick = ()=>answer(b);
    area.appendChild(b);
  });
}
function answer(btn){
  if(answered) return;
  answered = true;
  document.querySelectorAll(".choice").forEach(b=>{
    if(b.textContent === questions[i].answer) b.classList.add("correct");
    else if(b === btn) b.classList.add("wrong");
    b.disabled = true;
  });
}
function next(){
  if(!answered) return alert("回答してください");
  i++;
  i >= questions.length ? finish() : show();
}

/* =====================================================
   終了処理（Legendary分岐）
===================================================== */
function finish(){
  const score = addGrowthScore();
  const type = drawHeroType(score);
  const hero = getHeroByType(type);
  saveHero(hero);

  type === "legendary"
    ? showLegendaryDraw(hero)
    : showHeroOverlay(type, hero);
}

/* ===== Legendary演出 ===== */
function showLegendaryDraw(hero){
  const overlay = document.createElement("div");
  overlay.className = "overlay";
  overlay.innerHTML = `<div class="card-back">LEGENDARY</div>`;
  document.body.appendChild(overlay);

  setTimeout(()=>{
    overlay.innerHTML = `
      <div class="hero legendary">
        <h2>${hero.name}</h2>
        <p>（${hero.job}）</p>
        <p>「${hero.quote}」</p>
        <button style="margin-top:16px" onclick="location.href='heroes.html'">
          図鑑へ
        </button>
      </div>
    `;
  },1200);
}

/* ===== 通常カード ===== */
function showHeroOverlay(type, hero){
  const overlay = document.createElement("div");
  overlay.className = "overlay";
  overlay.innerHTML = `
    <div class="hero ${type}">
      <h2>${hero.name}</h2>
      <p>（${hero.job}）</p>
      <p>「${hero.quote}」</p>
      <button style="margin-top:16px" onclick="location.href='heroes.html'">
        図鑑へ
      </button>
    </div>
  `;
  document.body.appendChild(overlay);
}

/* 初期表示 */
questions.length ? show()
  : document.getElementById("q").textContent = "⚠ 問題が登録されていません";
</script>

</body>
</html>
